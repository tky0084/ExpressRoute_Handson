## はじめに
今回のAzure - OCI Cloud間の閉域接続環境において、Azure環境の観点で以下の内容を検証する
- ExpressRoute回線の帯域占有時における他の通信についての影響
- 帯域ひっ迫の検知方法
- Azure環境における通信の強制終了方法について

***

## 検証方法<br>
Azure 環境において、以下のネットワーク構成を作成<br>
※作成方法はこちら
- [環境構築1_Azure環境の作成]<https://github.com/tky0084/ExpressRoute_Handson/blob/main/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%891_Azure%E7%92%B0%E5%A2%83%E3%81%AE%E4%BD%9C%E6%88%90%20.md>
- [環境構築2_OCI環境の作成]<https://github.com/tky0084/ExpressRoute_Handson/blob/main/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%892.%20OCI%E7%92%B0%E5%A2%83%E3%81%AE%E4%BD%9C%E6%88%90.md>
- [環境構築3_閉域回線の接続]<https://github.com/tky0084/ExpressRoute_Handson/blob/main/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%893_%E9%96%89%E5%9F%9F%E5%9B%9E%E7%B7%9A%E3%81%AE%E6%8E%A5%E7%B6%9A.md>

![alt text](/img/ネットワーク構成図.png)<br>

<br>

以下の操作を実行する
- OCI環境のインスタンスのCドライブに、共有ファイルを作成する
- Azure環境VM1にて、帯域を圧迫する10GBファイルを2つ作成する
- 作成したファイルをAzure VMからSMBでコピーする
- 帯域を使用している間、もう一つのAzure環境VM2にて、OCI環境への通信ができるかを確認する

![alt text](</img/スクリーンショット 2026-02-15 123550.png>)<br>

<br>

***

## 帯域の状態
ExpressRoute回線を経由した大容量ファイルをコピーする通信により、帯域使用率は100%を超過

![alt text](</img/スクリーンショット 2026-02-14 120410.png>)<br>

<br>

帯域上昇により、帯域使用率のアラート受信を確認

![alt text](</img/スクリーンショット 2026-02-15 123933.png>)<br>

<br>

さらに、パケットのドロップが起こった旨のアラートも確認

![alt text](</img/スクリーンショット 2026-02-15 124642.png>)<br>

<br>

***

## この状態で他のVMから通信を行うとどうなるか

Azure環境に作成したもう一つの仮想マシンにて、OCI Cloudにping確認を行うと、ping疎通ができていることを確認

![alt text](</img/スクリーンショット 2026-02-14 122416.png>)<br>

<br>

さらに、テキストファイルを作って送信しても、すぐにコピーが実施された

![alt text](</img/スクリーンショット 2026-02-15 125314.png>)<br>

<br>

以上のことから、帯域を圧迫していても、他の通信が全くできなくなるというわけではないことがわかる

***

## 通信を止める方法

送信側のNSGの最上位の規則に、すべての通信をDenyするルールを作っても、通信が止まる気配がなく、アップロードが継続されている

![alt text](</img/スクリーンショット 2026-02-14 134540.png>)<br>

<br>

一方、defaultサブネットに空のルートテーブルをアタッチすると、通信先が見つからないとエラーになり、アップロードが中止された

![alt text](</img/スクリーンショット 2026-02-14 135028.png>)<br>

<br>

以上のことから、ルートテーブルでルーティングを不正な状態にして、対向先への通信ルートが見つからない状態にすることが有効であることがわかる<br>

<br>

補足：
今回は検証コストの都合上、Azureのネットワーク構成は単体のネットワークで、かつAzureFirewallのないネットワーク構成で実装した。<br>
ハブアンドスポークに置き換える場合、ルートテーブルが作成されているため、サブネットから関連付けを外すことで通信を遮断することが可能である。<br>
これを自動化する場合、帯域使用率、およびパケットのドロップを検知するメトリックアラートをトリガーにしてAutomationアカウントのRunbookでスクリプトを起動し、<br>
Vnetフローログから大量のパケット通信が発生している宛先、Vnetを特定し、ルートテーブルの関連付けを外す形であれば対応が可能であると考えられる。<br>

<br>

また、対向側からの通信については、VPNゲートウェイサブネットに関連付けられたルートテーブルを外しても、イングレス通信がExpressRouteを通るところまでは変わらないため、Azure側から帯域占有を防ぐことは不可能。<br>

***

## 結論
- 帯域を占有していたとしても、他の通信が全くできなくなるわけではない。
- 帯域を占有していた場合、Azure側では通信帯域を制御するサービスが存在しないため、意図的に止めるにはルーティングを無効化する必要があるが、
- Azureのベストプラクティスにも通信の強制終了という方法が推奨事項に記載されておらず、他のワークロードにまで影響が出る可能性を考えると、望ましい対策とは現状言い難い。
- そもそもExpressRoute回線はスケーラブルなリソースではないため、段階的に帯域幅を上げることが必要あり、そのためには日常的に帯域を監視する必要がある。<br>
  →　https://learn.microsoft.com/ja-jp/azure/well-architected/service-guides/azure-expressroute#configuration-recommendations-40
- 帯域の占有を検知する方法として、日常的にダッシュボードで確認する方法や、閾値をトリガーとしてアラートメール通知がある