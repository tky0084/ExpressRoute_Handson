# ExpressRoute帯域占有時の影響検証

## 概要

本検証では、Microsoft AzureとOracle Cloud Infrastructure（OCI）をExpressRouteおよびFastConnectによる閉域接続で接続した環境において、  

**ExpressRoute回線の帯域を占有した場合にどのような影響が発生するか**  

について、Azure環境の観点から検証を実施した。

検証観点は以下の通り。

- ExpressRoute回線の帯域占有時における他通信への影響
- 帯域ひっ迫の検知方法
- Azure環境における通信の強制停止方法

---

## 検証方法

事前に以下の構成を構築する。

- Azure環境
- OCI環境
- ExpressRoute × FastConnect による閉域接続

![alt text](/img/ネットワーク構成図.png)

### 実施内容

以下の手順で帯域を意図的に占有する。

1. Azure VM1にて10GBの大容量ファイルを2つ作成
2. OCIインスタンスのCドライブに共有フォルダを作成
3. Azure VM1からOCIへSMBコピーを実施
4. コピー中にAzure VM2からOCIへの通信可否を確認

---

## 大容量ファイルの作成

Azure VM1のコマンドプロンプトで以下を実行する。

```cmd
cd /
mkdir test
cd test
fsutil file createnew C:\test\10GB_testfile.bin 10737418240
```

## 大容量ファイルの転送

Azure VM1で作成したファイルを、OCIのインスタンスにコピーする

![alt text](</img/スクリーンショット 2026-02-15 123550.png>)<br>


## 帯域の状態

ExpressRoute回線経由で大容量ファイルをコピーすることで、帯域使用率は100％を超過した。

![alt text](</img/スクリーンショット 2026-02-14 120410.png>)

<br>

帯域使用率上昇により、メトリックアラートの受信を確認。

![alt text](</img/スクリーンショット 2026-02-15 123933.png>)

<br>

さらに、パケットドロップが発生した旨のアラートも確認。

![alt text](</img/スクリーンショット 2026-02-15 124642.png>)

<br>

---

## 帯域ひっ迫時の他通信への影響

帯域が100％を超過している状態で、  Azure VM2からOCIへpingを実施。

結果として、**ping疎通は継続して成功**した。

![alt text](</img/スクリーンショット 2026-02-14 122416.png>)

<br>

さらに、小容量のテキストファイルをコピーしたところ、即座に転送が完了した。

![alt text](</img/スクリーンショット 2026-02-15 125314.png>)

<br>

### 結果

帯域を大容量通信で占有していても、**他の通信が完全に停止するわけではない**ことを確認した。

<br>
---

## 通信を止める方法の検証

### 1. NSGで全拒否ルールを追加

送信元サブネットのNSGにて、最優先ルールで「すべての通信をDeny」に設定。<br>
しかし、既存セッションは継続し、アップロードは停止しなかった。

![alt text](</img/スクリーンショット 2026-02-14 134540.png>)

<br>

---

### 2. ルートテーブルの無効化

defaultサブネットに対し、  空のルートテーブルを関連付けた。

<br>

結果として、

- 宛先へのルートが見つからないエラーが発生
- アップロードが即時中止

![alt text](</img/スクリーンショット 2026-02-14 135028.png>)

<br>

### 結果

通信を強制的に停止させるには、

> ルーティングを不正状態にし、対向先への経路を消す

ことが有効であると確認できた。

---

## 補足事項

- 本検証では単一VNet構成で実施（Azure Firewallなし）
- Hub & Spoke構成の場合は、ルートテーブルの関連付け解除で遮断可能
- 自動化する場合は以下の構成が考えられる

### 自動化イメージ

1. ExpressRouteメトリック（帯域使用率／パケットドロップ）を監視  
2. 閾値超過でメトリックアラートを発火  
3. Automation Runbookを起動  
4. VNetフローログから高トラフィック宛先を特定  
5. 該当サブネットのルートテーブル関連付けを解除  

---

## 重要な制約事項

対向（OCI）側からのイングレストラフィックについては、

- ExpressRouteを通過する段階では制御不可
- GatewaySubnetのルートを外しても受信自体は防げない可能性が高い

つまり、Azure側のみで**完全な帯域占有防止は困難**である。

---

## 結論

- 帯域を占有しても、他通信が完全停止するわけではない
- AzureにはExpressRoute帯域を直接制御する仕組みは存在しない
- 強制停止するにはルーティング無効化が有効だが、影響範囲が大きく、Microsoftのベストプラクティスにも存在しない
- ExpressRouteはスケーラブルなリソースではないため、段階的な帯域増強が必要
- 日常的な帯域監視およびメトリックアラート設定が重要

---

## 総括

ExpressRoute回線の帯域占有は、

- 即時の全面停止には直結しない
- しかし通信品質低下およびパケットロスを発生させる

したがって、

**事前の監視設計と適切な帯域設計こそが最も重要な対策である。**

以上
